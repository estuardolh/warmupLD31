<!DOCTYPE html> 
<html>
	<head>
		<script src="./jaws-dynamic.js" type="text/javascript"></script>
		<title>asdf hahaha</title>
		<meta charset="UTF8" ></meta>
	</head>
	<body bgcolor="black">
		<center>
			<canvas width=400 height=600 style="background-color: gray;"></canvas>
		</center>
		<script>
			function Asdf(){
				var bubbles;
				var current_bubble = null;
				var shooter;
				var time_left = 0;
				var text_time_left;
				var bubble_diameter = 20;
				
				var distanceBetween = function( bubble1, bubble2 ){
					return Math.sqrt( Math.pow(bubble1.x - bubble2.x , 2) + Math.pow( bubble1.y - bubble2.y, 2 ) );
				};
				
				this.setup = function(){
					var bubble_w = 20;
					var bubble_h = 20;
					bubbles = new jaws.SpriteList();
					
					text_time_left = new jaws.Text({ text: "LEFT TIME: ", x:200 , y:20, color: "white", fontSize: 12, style: "bold" });
					
					var group_offset_x = 2;
					var group_offset_y = 4;					
					
					// init bubbles
					var init_w = 16;
					var init_h = 16;
					for( var i = 0; i < init_w; i ++ ){
						for( var j = 0 ; j < init_h ; j ++ ){
							// random
							var image_src;
							var image_daColor;
							var image_random = 0;
							image_random = Math.random();
							
							if( image_random > 0 & image_random <= 0.3 ){
								image_src = "./img/bubble_green.png";
								image_daColor = "green";
							}else if( image_random > 0.3 & image_random <= 0.6 ){
								image_src = "./img/bubble_blue.png";
								image_daColor = "blue";
							}else if( image_random > 0.6 & image_random <= 1 ){
								image_src = "./img/bubble_red.png";
								image_daColor = "red";
							}
							var a_bubble = new jaws.Sprite({ image: image_src, x: (i+group_offset_x) * bubble_w , y: (j+group_offset_y) * bubble_h, anchor: "center_center" });
							a_bubble.daColor = image_daColor;
							a_bubble.visible = true;
							a_bubble.toPop = false;
							
							bubbles.push( a_bubble );
						}
					}
					
					// a bubble must be stick now ?
					bubbles.stick = function( bubble ){
						var res = false;
						
						// bubble touch others ?
						bubbles.forEach(function(entry){
							var distance_between = 0;
							
							distance_between = distanceBetween(entry, bubble);
							
							if( distance_between <= bubble_diameter + 1 && entry.visible == true ){
								// console.log("because entry_x: "+entry.x+" entry_y: "+entry.y+" bubble_x: "+bubble.x+" bubble_y: "+bubble.y);
								
								//bubble.x -= bubble.vx;
								//bubble.y -= bubble.vy;
								
								res = true;
								
								return;
							}
						});
						
						return res;
					};
					
					// some pop? 
					bubbles.pop = function( bubble ){
						// color filter!
						/*
						bubbles.filter(function( element, bubble ){
							console.log("color = "+bubble.daColor);
							return element.daColor == bubble.daColor;
						}).forEach(function( element ){
							element.toPop = true;
						});
						*/
						
						var validateColor = function( element ){
							return element.daColor == bubble.daColor && element.visible == true && bubble.visible == true;
						};
						
						// only color-sisters
						var color_bubbles = bubbles.filter(validateColor);
						
						var validateSisters = function( element ){
							var sisters_count = 0;
						
							color_bubbles.forEach(function( entry ){
								if( distanceBetween( element, entry ) <= 1.1*bubble_diameter 
									&& ( entry.toPop == true || element.toPop == true )
									&& ( entry.visible == true && element.visible == true )  ){
									sisters_count ++;
									entry.toPop = true;
									element.toPop = true;
								}
							});
							
							return sisters_count > 0;
						}
						
						// only near-sisters
						var near_bubbles = color_bubbles.filter(validateSisters);
						near_bubbles = color_bubbles.reverse().filter(validateSisters);
						
						// how many to pop ?
						var how_many = 0;
						bubbles.forEach(function( element ){
							if( element.toPop == true ) how_many ++
						})
						
						if( how_many > 1 ){
							// pop now!
							bubbles.forEach(function( element ){
								if( element.toPop == true ){
									element.visible = false;
								}
							});
						}
						
						// unmark all
						bubbles.forEach(function( element ){
							element.toPop = false;
						});
					};
					
					// init shooter
					var shooter_w = 20;
					var shooter_h = 50;
					shooter = new jaws.Sprite({ image: "./img/shooter.png", x: jaws.width / 2, y: jaws.height, anchor: "bottom_center" });
					
					// shot another bubble!
					shooter.shot = function( a_vx, a_vy ){
						if( current_bubble != null ){
							return;
						}
						
						current_bubble = new jaws.Sprite({ image: "./img/bubble_green.png", x: this.x , y: this.y , anchor:"center_center"});
						current_bubble.vx = a_vx;
						current_bubble.vy = a_vy;
						current_bubble.visible = true;
						current_bubble.toPop = false;
						current_bubble.daColor = "green";		// random me?
						current_bubble.life_time = 60;
						current_bubble.update = function(){
							this.move( this.vx , this.vy );
						}
					}
				};
				
				this.update = function(){
					var x2 = jaws.width / 2;
					var y2 = jaws.height;
					var x1 = jaws.mouse_x;
					var y1 = jaws.mouse_y;
					
					var dx = ( x2 - x1 ) * -1;
					var dy = Math.abs( y2 - y1 );
					
					if( dy != 0  ){
						radians = Math.atan( dx / dy );
						
						var degrees = radians * ( 180 / Math.PI );
						
						shooter.rotateTo( degrees );
						if (jaws.pressed("left_mouse_button") ){
							
							var a = Math.sqrt( Math.pow( dy, 2 ) + Math.pow( dx , 2 ) );

							var factor = 12;
							
							shooter.shot( (dx / a)*factor , ( -1 * ( Math.abs( dy/ a ) ) )*factor );
						}
					}
					
					if( current_bubble != null ){
						current_bubble.update();
					
						var bubble_stick = false;
						bubble_stick = bubbles.stick( current_bubble );
						
						if( bubble_stick == true ){
							var new_bubble = new jaws.Sprite({ image: current_bubble.image, x: current_bubble.x, y: current_bubble.y, anchor:"center_center"});
							new_bubble.daColor = current_bubble.daColor;
							new_bubble.visible = true;
							new_bubble.toPop = true;
							
							bubbles.push( new_bubble );
							bubbles.pop( new_bubble );
						 
							current_bubble = null;
						}
					}
				};
				
				this.draw = function(){
					jaws.clear();
					
					text_time_left.draw();
					bubbles.forEach(function(entry){
						if( entry.visible == true ){
							entry.draw();
						}
					})
					shooter.draw();
					
					if( current_bubble != null ){
						current_bubble.draw();
					}
				};
			}
		
			jaws.onload = function(){
				jaws.unpack();
				jaws.assets.add(["./img/bubble_red.png", "./img/bubble_green.png", "./img/bubble_blue.png", "./img/shooter.png"]);
				jaws.start( Asdf );
			}
		</script>
	</body>
</html>