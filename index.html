<!DOCTYPE html> 
<html>
	<head>
		<script src="./jaws-dynamic.js" type="text/javascript"></script>
		<title>asdf hahaha</title>
		<meta charset="UTF8" ></meta>
	</head>
	<body bgcolor="black">
		<center>
			<canvas width=400 height=600 style="background-color: gray;"></canvas>
		</center>
		<script>
			function Asdf(){
				var bubbles;
				var current_bubble = null;
				var shooter;
				var time_left = 0;
				var text_time_left;
				
				this.setup = function(){
					var bubble_w = 20;
					var bubble_h = 20;
					bubbles = new jaws.SpriteList();
					
					text_time_left = new jaws.Text({ text: "LEFT TIME: ", x:200 , y:20, color: "white", fontSize: 12, style: "bold" });
					
					var group_offset_x = 2;
					var group_offset_y = 4;					
					
					// init bubbles
					var init_w = 16;
					var init_h = 16;
					for( var i = 0; i < init_w; i ++ ){
						for( var j = 0 ; j < init_h ; j ++ ){
							// random
							var image_src;
							var image_random = 0;
							image_random = Math.random();
							
							if( image_random > 0 & image_random <= 0.3 ){
								image_src = "./img/bubble_green.png";
							}else if( image_random > 0.3 & image_random <= 0.6 ){
								image_src = "./img/bubble_blue.png";
							}else if( image_random > 0.6 & image_random <= 1 ){
								image_src = "./img/bubble_red.png";
							}
							
							bubbles.push( new jaws.Sprite({ image: image_src, x: (i+group_offset_x) * bubble_w , y: (j+group_offset_y) * bubble_h, anchor: "center_center" }) );
						}
					}
					
					// a bubble must be stick now ?
					bubbles.stick = function( bubble ){
						var res = false;
					
						// bubble touch others ?
						bubbles.forEach(function(entry){
							var bubble_diameter = 20;
							var distance_between = 0;
							
							distance_between = Math.sqrt( Math.pow(entry.x - bubble.x , 2) + Math.pow( entry.y - bubble.y, 2 ) );
							
							if( parseInt(distance_between) <= bubble_diameter + 1 ){
								// console.log("because entry_x: "+entry.x+" entry_y: "+entry.y+" bubble_x: "+bubble.x+" bubble_y: "+bubble.y);
								
								res = true;
								
								return;
							}
						});
						
						return res;
					}
					
					// init shooter
					var shooter_w = 20;
					var shooter_h = 50;
					shooter = new jaws.Sprite({ image: "./img/shooter.png", x: jaws.width / 2, y: jaws.height, anchor: "bottom_center" });
					
					// shot another bubble!
					shooter.shot = function( a_vx, a_vy ){
						if( current_bubble != null ){
							return;
						}
						
						current_bubble = new jaws.Sprite({ image: "./img/bubble_green.png", x: this.x , y: this.y , anchor:"center_center"});
						current_bubble.vx = a_vx;
						current_bubble.vy = a_vy;
						current_bubble.life_time = 60;
						current_bubble.update = function(){
							this.move( this.vx , this.vy );
						}
					}
				};
				
				this.update = function(){
					var x2 = jaws.width / 2;
					var y2 = jaws.height;
					var x1 = jaws.mouse_x;
					var y1 = jaws.mouse_y;
					
					var dx = ( x2 - x1 ) * -1;
					var dy = Math.abs( y2 - y1 );
					
					if( dy != 0  ){
						radians = Math.atan( dx / dy );
						
						var degrees = radians * ( 180 / Math.PI );
						
						shooter.rotateTo( degrees );
						if (jaws.pressed("left_mouse_button") ){
							
							var a = Math.sqrt( Math.pow( dy, 2 ) + Math.pow( dx , 2 ) );

							var factor = 12;
							
							shooter.shot( (dx / a)*factor , ( -1 * ( Math.abs( dy/ a ) ) )*factor );
						}
					}
					
					if( current_bubble != null ){
						current_bubble.update();
					
						var bubble_stick = false;
						bubble_stick = bubbles.stick( current_bubble );
						
						if( bubble_stick == true ){
							var new_bubble = new jaws.Sprite({ image: current_bubble.image, x: current_bubble.x, y: current_bubble.y, anchor:"center_center"});
							
							bubbles.push( new_bubble );
						 
							current_bubble = null;
						}
					}
				};
				
				this.draw = function(){
					jaws.clear();
					
					text_time_left.draw();
					bubbles.draw();
					shooter.draw();
					
					if( current_bubble != null ){
						current_bubble.draw();
					}
				};
			}
		
			jaws.onload = function(){
				jaws.unpack();
				jaws.assets.add(["./img/bubble_red.png", "./img/bubble_green.png", "./img/bubble_blue.png", "./img/shooter.png"]);
				jaws.start( Asdf );
			}
		</script>
	</body>
</html>